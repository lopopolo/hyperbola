---
- hosts: app
  become: true
  become_method: sudo
  become_user: root
  tasks:
    - name: base packages
      apt: name={{ item }} state=present
      with_items:
      - mysql-server
      - mysql-client
      - python3-mysqldb
    - name: Enable MySQL remote connections
      copy:
        content: "[mysqld]\nbind-address = 0.0.0.0"
        dest: /etc/mysql/mysql.conf.d/mysqld.overrides.cnf
    - name: Drop database
      mysql_db:
        name: hyperbola
        state: absent
    - name: Create database
      mysql_db:
        name: hyperbola
        encoding: utf8mb4
        collation: utf8mb4_unicode_ci
        state: present
    - name: Create app MySQL user
      mysql_user:
        name: app
        password: mysql-local
        host: '192.168.10.20'
        priv: 'hyperbola.*:ALL'
        state: present
    - name: Test for MySQL timezone support
      command: mysql -NBe "SELECT COUNT(*) FROM mysql.time_zone"
      register: mysql_timezones_count
      changed_when: false
      check_mode: no
    - name: Enable MySQL timezone support
      shell: mysql_tzinfo_to_sql /usr/share/zoneinfo | mysql -u root mysql
      when: mysql_timezones_count.stdout|int < 1
      tags:
        - skip_ansible_lint
    - name: Restart MySQL
      systemd: state=restarted name=mysql
